#!/usr/bin/env node

/**
 * Generate build metadata for Netlify deployments
 * This script runs during the build process and injects deployment information
 * into the environment.prod.ts file
 */

const fs = require('fs');
const path = require('path');

// Netlify environment variables (available during build)
const buildInfo = {
  buildId: process.env.BUILD_ID || 'local-dev',
  deployId: process.env.DEPLOY_ID || 'local',
  commitRef: process.env.COMMIT_REF || 'unknown',
  context: process.env.CONTEXT || 'development', // production, deploy-preview, branch-deploy, dev
  deployTime: new Date().toISOString(),
  deployUrl: process.env.DEPLOY_URL || 'http://localhost:4200',
  version: require('../package.json').version
};

// Extract short commit hash (first 7 characters)
const shortCommit = buildInfo.commitRef.substring(0, 7);

// Extract last 8 characters of deploy ID for display
const shortDeployId = buildInfo.deployId.length > 8 
  ? buildInfo.deployId.substring(buildInfo.deployId.length - 8) 
  : buildInfo.deployId;

// Create the environment.prod.ts content
const envContent = `// This file is auto-generated by scripts/generate-build-info.js during Netlify deployment
// Do not edit manually - changes will be overwritten on next build

export const environment = {
  production: true,
  googleClientId: '324607101110-jm62j15nm96l1pn0u4dtapr0iie6u5ei.apps.googleusercontent.com',
  
  // Build metadata (auto-generated from Netlify environment)
  build: {
    buildId: '${buildInfo.buildId}',
    deployId: '${buildInfo.deployId}',
    shortDeployId: '${shortDeployId}',
    commitRef: '${buildInfo.commitRef}',
    shortCommit: '${shortCommit}',
    context: '${buildInfo.context}',
    deployTime: '${buildInfo.deployTime}',
    deployUrl: '${buildInfo.deployUrl}',
    version: '${buildInfo.version}'
  }
};
`;

// Write to environment.prod.ts
const envPath = path.join(__dirname, '../src/environments/environment.prod.ts');
fs.writeFileSync(envPath, envContent, 'utf8');

console.log('âœ… Build metadata generated successfully!');
console.log(`   Deploy ID: ${shortDeployId}`);
console.log(`   Commit: ${shortCommit}`);
console.log(`   Context: ${buildInfo.context}`);
console.log(`   Time: ${buildInfo.deployTime}`);
