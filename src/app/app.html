<!-- Sidebar Section -->
<div class="sidebar" [class.collapsed]="sidebarCollapsed">
  <!-- Clock Widget -->
  <div class="clock-widget">
    <div class="clock-time">{{ currentTime() }}</div>
    <div class="clock-date">{{ currentDate() }}</div>
  </div>

  <!-- Upper Section: Navigation -->
  <div class="sidebar-upper">
    <nav class="sidebar-nav">
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'input'"
        (click)="switchTab('input')"
        title="Input Data">
        <i data-lucide="clipboard"></i>
        <span class="nav-text">Input Data</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'dashboard'"
        (click)="switchTab('dashboard')"
        title="Dashboard">
        <i data-lucide="bar-chart-3"></i>
        <span class="nav-text">Dashboard</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'v2'"
        (click)="switchTab('v2')"
        title="V2 Dashboard">
        <i data-lucide="trending-up"></i>
        <span class="nav-text">V2 Dashboard</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'change-track'"
        (click)="switchTab('change-track')"
        title="Change Track">
        <i data-lucide="arrow-left-right"></i>
        <span class="nav-text">Change Track</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'stock-radar'"
        (click)="switchTab('stock-radar')"
        title="Stock Radar">
        <i data-lucide="radar"></i>
        <span class="nav-text">Stock Radar</span>
      </button>
      <button 
        class="nav-item" 
        [class.active]="activeTab === 'help'"
        (click)="switchTab('help')"
        title="Help">
        <i data-lucide="help-circle"></i>
        <span class="nav-text">Help</span>
      </button>
    </nav>
  </div>

  <!-- Elegant Separator / Toggle -->
  <div class="sidebar-separator" 
       (click)="toggleSidebar()" 
       [title]="sidebarCollapsed ? 'Expand Sidebar' : 'Collapse Sidebar'">
    <div class="separator-line" *ngIf="!sidebarCollapsed"></div>
    <div class="separator-icon">
      <i [attr.data-lucide]="sidebarCollapsed ? 'chevrons-right' : 'chevrons-left'"></i>
    </div>
    <div class="separator-line" *ngIf="!sidebarCollapsed"></div>
  </div>

  <!-- Lower Section: Links, Settings, Build Info -->
  <div class="sidebar-lower">
    <!-- Wake Lock Toggle -->
    <div class="wake-lock-section">
      <div class="setting-item">
        <div class="setting-content">
          <label class="toggle-switch" title="Keep screen awake">
            <input 
              type="checkbox" 
              [(ngModel)]="isWakeLockActive"
              (change)="toggleWakeLock()"
            />
            <span class="toggle-slider"></span>
          </label>
          <span class="setting-label">{{ isWakeLockActive ? '‚òÄÔ∏è Wake Lock' : 'üåô Sleep' }}</span>
        </div>
      </div>
    </div>

    <!-- Quick Links Section -->
    <div class="quick-links-section">
      <div class="section-header" *ngIf="!sidebarCollapsed">
        <i data-lucide="link-2"></i>
        <span>Quick Access</span>
      </div>
      <div class="quick-links-grid">
        <a href="https://claude.ai/public/artifacts/fc830a0c-7e32-47c4-b3f7-61b45bbb859a" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="quick-link-card"
           title="Nov 24 - Dec 25">
          <div class="link-icon">
            <i data-lucide="calendar-range"></i>
          </div>
          <span class="link-label">Nov-Dec</span>
        </a>
        <a href="https://claude.ai/public/artifacts/83aec5af-de25-4fe1-a249-37e58c35df33" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="quick-link-card"
           title="Big Losses">
          <div class="link-icon loss">
            <i data-lucide="trending-down"></i>
          </div>
          <span class="link-label">Losses</span>
        </a>
        <a href="https://claude.ai/public/artifacts/f8f5196c-3a9f-48ac-b61b-5e5eaf4774f2" 
           target="_blank" 
           rel="noopener noreferrer" 
           class="quick-link-card"
           title="P & L Breakup">
          <div class="link-icon profit">
            <i data-lucide="pie-chart"></i>
          </div>
          <span class="link-label">Breakup</span>
        </a>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="settings-section">
      <div class="section-header" *ngIf="!sidebarCollapsed">
        <i data-lucide="settings"></i>
        <span>Settings</span>
      </div>

      <!-- Google Drive Connect -->
      <div class="setting-item drive-setting">
        <button 
          *ngIf="!driveService.isConnected()" 
          (click)="connectGoogleDrive()" 
          class="btn-connect-drive-sidebar"
          [disabled]="isConnectingDrive">
          <i data-lucide="cloud"></i>
          <span *ngIf="!sidebarCollapsed">{{ isConnectingDrive ? 'Connecting...' : 'Connect Drive' }}</span>
        </button>
        <div *ngIf="driveService.isConnected()" class="drive-connected-status">
          <div class="connected-badge" *ngIf="!sidebarCollapsed">
            <i data-lucide="check-circle"></i>
            <span>Drive Connected</span>
          </div>
          <button (click)="disconnectGoogleDrive()" class="btn-disconnect-sidebar" [title]="sidebarCollapsed ? 'Disconnect Drive' : ''">
            <i data-lucide="x-circle"></i>
            <span *ngIf="!sidebarCollapsed">Disconnect</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sidebar Footer: Build Info -->
  <div class="sidebar-footer">
    <div class="build-info" *ngIf="!sidebarCollapsed">
      <div class="build-context" [class.production]="buildInfo.context === 'production'">
        {{ buildInfo.context }}
      </div>
      <div class="build-version">v{{ buildInfo.version }}</div>
      <div class="build-deploy">{{ buildInfo.shortDeployId }}</div>
      <div class="build-commit">{{ buildInfo.shortCommit }}</div>
    </div>
    <div class="build-info-collapsed" *ngIf="sidebarCollapsed">
      <lucide-icon name="info" [size]="16"></lucide-icon>
    </div>
  </div>
</div>

<!-- Mobile Backdrop -->
<div class="sidebar-backdrop" *ngIf="!sidebarCollapsed && isMobileView" (click)="toggleSidebar()"></div>

<!-- Main Content Area -->
<div class="main-content" [class.sidebar-collapsed]="sidebarCollapsed">
  <div class="container">
    <!-- Input Tab -->
    <div *ngIf="activeTab === 'input'" class="tab-content">
      <div class="input-section">
        <h2 style="margin-bottom: 25px; color: #ffc107;">Enter Trading Contract Data</h2>
        
        <!-- Excel Upload Section -->
        <div class="upload-section">
          <label class="upload-label">
            üìä Upload Excel File
            <span style="font-size: 0.85em; color: #888; margin-left: 10px;">
              (Columns: Symbol, Realized P&L)
            </span>
          </label>
          <div class="upload-area">
            <input 
              type="file" 
              id="fileUpload"
              accept=".xlsx,.xls"
              (change)="onFileChange($event)"
              style="display: none">
            <label for="fileUpload" class="upload-btn">
              üìÅ Choose Excel File
            </label>
            <span *ngIf="uploadedFileName" class="file-name">{{ uploadedFileName }}</span>
          </div>
          <div class="upload-info">
            <strong>Excel Format:</strong> Column A: Symbol, Column B: Realized P&L (Type auto-detected from symbol name)
          </div>
          <!-- Upload feedback UI -->
          <div class="upload-feedback" *ngIf="uploadInProgress || uploadStatusMessage">
            <div *ngIf="uploadInProgress" class="progress-wrapper">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="uploadProgress"></div>
              </div>
              <div class="progress-text">{{ uploadProgress }}% {{ uploadPhase }}</div>
            </div>
            <div *ngIf="!uploadInProgress && uploadStatusMessage" class="status-message" [class.success]="uploadSuccess" [class.error]="uploadError">
              <span>{{ uploadStatusMessage }}</span>
              <button class="close-status" (click)="clearUploadStatus()">‚úñ</button>
            </div>
          </div>
        </div>

        <div class="divider">OR Enter Manually</div>

        <!-- Manual Input Form -->
        <div class="form-group">
          <label>Month & Year</label>
          <input 
            type="month" 
            [(ngModel)]="formData.monthYear"
            class="form-control">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Contract Name</label>
            <input 
              type="text" 
              [(ngModel)]="formData.contractName"
              placeholder="e.g., WIPRO25DECFUT"
              class="form-control">
          </div>
          <div class="form-group">
            <label>Contract Type</label>
            <select [(ngModel)]="formData.contractType" class="form-control">
              <option value="regular">Regular</option>
              <option value="nifty">NIFTY</option>
            </select>
          </div>
        </div>

        <div class="form-group">
          <label>Profit/Loss (‚Çπ)</label>
          <input 
            type="number" 
            [(ngModel)]="formData.contractPnL"
            placeholder="e.g., 18600 or -5000"
            step="0.01"
            class="form-control">
        </div>

        <div style="margin-top: 25px;">
          <button class="btn" (click)="addContract()">‚ûï Add Contract</button>
          <button class="btn btn-secondary" (click)="clearAll()">üóëÔ∏è Clear All</button>
          <button class="btn btn-secondary" (click)="downloadTemplate()">‚¨áÔ∏è Download Template</button>
        </div>

        <!-- Contracts List -->
        <div class="contracts-list">
          <h3 *ngIf="contracts.length > 0" style="margin: 30px 0 15px 0; color: #ffc107;">
            Added Contracts
          </h3>
          <p *ngIf="contracts.length === 0" style="text-align: center; color: #888; padding: 20px;">
            No contracts added yet
          </p>
          <div 
            *ngFor="let contract of contracts; let i = index; trackBy: trackByIndex"
            class="contract-item"
            [class.profit]="contract.pnl >= 0"
            [class.loss]="contract.pnl < 0">
            <div>
              <strong>{{ contract.name }}</strong>
              <span style="color: #888; margin-left: 15px;">{{ formatMonth(contract.monthYear) }}</span>
              <span 
                class="badge"
                [style.background]="contract.type === 'nifty' ? 'rgba(33, 150, 243, 0.3)' : 'rgba(255, 193, 7, 0.3)'">
                {{ contract.type === 'nifty' ? 'NIFTY' : 'REGULAR' }}
              </span>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
              <span 
                style="font-size: 1.2em; font-weight: bold;"
                [style.color]="contract.pnl >= 0 ? '#4caf50' : '#f44336'">
                ‚Çπ{{ formatNumber(contract.pnl) }}
              </span>
              <button class="delete-btn" (click)="deleteContract(i)">Delete</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Dashboard Tab -->
    <div *ngIf="activeTab === 'dashboard'" class="tab-content">
      <div *ngIf="contracts.length === 0" class="empty-state">
        <h3>No Trading Data Available</h3>
        <p>Please add contracts in the Input Data tab to view the dashboard</p>
      </div>

      <div *ngIf="contracts.length > 0" class="dashboard" id="dashboard-content">
        <div class="dashboard-header">
          <h1>{{ getMonthName() }} TRADING PERFORMANCE DASHBOARD</h1>
          <button class="btn export-btn" (click)="exportDashboardAsImage()">üì∏ Export as Image</button>
        </div>

        <div class="overall-pnl">
          <h2>OVERALL REALIZED P&L</h2>
          <div 
            class="amount"
            [class.profit]="getTotalPnL() >= 0"
            [class.loss]="getTotalPnL() < 0">
            {{ getTotalPnL() >= 0 ? '+' : '-' }}‚Çπ{{ formatNumber(Math.abs(getTotalPnL())) }}
          </div>
          <div class="label">{{ getTotalPnL() >= 0 ? 'NET PROFIT' : 'NET LOSS' }}</div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="card-header">
              <span class="card-icon">üèÜ</span>
              <span class="card-title">MAJOR PROFIT CONTRIBUTORS</span>
            </div>
            <div *ngIf="getMajorProfits().length === 0" style="color: #888;">No profit contracts</div>
            <div 
              *ngFor="let contract of getMajorProfits()"
              class="contract-list-item">
              <span class="contract-name">{{ contract.name }}</span>
              <span class="contract-value profit">‚Çπ{{ formatNumber(contract.pnl) }}</span>
            </div>
            <div class="category-summary">
              Total Profit:
              <span class="summary-profit">‚Çπ{{ formatNumber(getRegularProfitTotal()) }}</span>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <span class="card-icon">‚≠ê</span>
              <span class="card-title">MAJOR LOSS CONTRIBUTORS</span>
            </div>
            <div *ngIf="getMajorLosses().length === 0" style="color: #888;">No loss contracts</div>
            <div 
              *ngFor="let contract of getMajorLosses()"
              class="contract-list-item">
              <span class="contract-name">{{ contract.name }}</span>
              <span class="contract-value loss">‚Çπ{{ formatNumber(contract.pnl) }}</span>
            </div>
            <div class="category-summary">
              Total Loss:
              <span class="summary-loss">‚Çπ{{ formatNumber(getRegularLossTotal()) }}</span>
            </div>
          </div>
        </div>

        <!-- NIFTY Futures Performance (full width) -->
        <div class="card nifty-futures-card">
          <div class="card-header">
            <span class="card-icon">üìâ</span>
            <span class="card-title">NIFTY FUTURES PERFORMANCE</span>
          </div>
          <div class="nifty-futures-overall">
            <strong>Overall NIFTY Futures P&L:</strong>
            <span 
              [style.color]="getNiftyFuturesTotal() >= 0 ? '#4caf50' : '#f44336'"
              style="font-weight: bold; font-size: 1.2em; margin-left: 10px;">
              {{ getNiftyFuturesTotal() >= 0 ? '+' : '' }}‚Çπ{{ formatNumber(Math.abs(getNiftyFuturesTotal())) }}
            </span>
          </div>
          <div class="nifty-futures-grid">
            <div>
              <h4 style="color: #4caf50; margin: 10px 0;">Top 5 Profit Makers</h4>
              <div *ngIf="getNiftyProfits().length === 0" style="color: #888; font-size: 0.9em;">No NIFTY profit contracts</div>
              <div 
                *ngFor="let contract of getNiftyProfits()"
                class="contract-list-item">
                <span class="contract-name">{{ contract.name }}</span>
                <span class="contract-value profit">‚Çπ{{ formatNumber(contract.pnl) }}</span>
              </div>
            </div>
            <div>
              <h4 style="color: #f44336; margin: 10px 0;">Top 5 Lossers</h4>
              <div *ngIf="getNiftyLosses().length === 0" style="color: #888; font-size: 0.9em; min-height: 120px; display: flex; align-items: center;">No NIFTY loss contracts</div>
              <div 
                *ngFor="let contract of getNiftyLosses()"
                class="contract-list-item">
                <span class="contract-name">{{ contract.name }}</span>
                <span class="contract-value loss">‚Çπ{{ formatNumber(contract.pnl) }}</span>
              </div>
            </div>
          </div>
          <div class="category-summary">
            NIFTY FUTURES Profit:
            <span class="summary-profit">‚Çπ{{ formatNumber(getNiftyFuturesProfitTotal()) }}</span>
            |
            NIFTY FUTURES Loss:
            <span class="summary-loss">‚Çπ{{ formatNumber(getNiftyFuturesLossTotal()) }}</span>
          </div>
        </div>

        <!-- NIFTY Options Performance Card -->
        <div class="card nifty-options-card">
          <div class="card-header">
            <span class="card-icon">üìà</span>
            <span class="card-title">NIFTY OPTIONS PERFORMANCE</span>
          </div>
          <div class="nifty-options-overall">
            <strong>Overall NIFTY Options P&L:</strong>
            <span 
              [style.color]="getNiftyOptionsTotal() >= 0 ? '#4caf50' : '#f44336'"
              style="font-weight: bold; font-size: 1.2em; margin-left: 10px;">
              {{ getNiftyOptionsTotal() >= 0 ? '+' : '' }}‚Çπ{{ formatNumber(Math.abs(getNiftyOptionsTotal())) }}
            </span>
          </div>
          <div class="nifty-options-grid">
            <div>
              <h4 style="color: #4caf50; margin: 15px 0 10px 0;">Top 5 Profits</h4>
              <div *ngIf="getNiftyOptionTopProfits().length === 0" style="color: #888; font-size: 0.9em;">No profit options</div>
              <div 
                *ngFor="let contract of getNiftyOptionTopProfits()"
                class="contract-list-item">
                <span class="contract-name">{{ contract.name }}</span>
                <span class="contract-value profit">‚Çπ{{ formatNumber(contract.pnl) }}</span>
              </div>
            </div>
            <div>
              <h4 style="color: #f44336; margin: 15px 0 10px 0;">Top 5 Losses</h4>
              <div *ngIf="getNiftyOptionTopLosses().length === 0" style="color: #888; font-size: 0.9em;">No loss options</div>
              <div 
                *ngFor="let contract of getNiftyOptionTopLosses()"
                class="contract-list-item">
                <span class="contract-name">{{ contract.name }}</span>
                <span class="contract-value loss">‚Çπ{{ formatNumber(contract.pnl) }}</span>
              </div>
            </div>
          </div>
          <div class="category-summary">
            NIFTY OPTION Profit:
            <span class="summary-profit">‚Çπ{{ formatNumber(getNiftyOptionsProfitTotal()) }}</span>
            |
            NIFTY OPTION Loss:
            <span class="summary-loss">‚Çπ{{ formatNumber(getNiftyOptionsLossTotal()) }}</span>
          </div>
        </div>

        <div class="summary-section">
          <h2>üìã {{ getMonthName() }} SUMMARY</h2>
          <div class="summary-stats">
            <div class="summary-stat">
              <div class="stat-label">Total Profit</div>
              <div class="stat-value" style="color: #4caf50;">‚Çπ{{ formatNumber(getTotalProfit()) }}</div>
            </div>
            <div class="summary-stat">
              <div class="stat-label">Total Loss</div>
              <div class="stat-value" style="color: #f44336;">‚Çπ{{ formatNumber(getTotalLoss()) }}</div>
            </div>
            <div class="summary-stat">
              <div class="stat-label">Net {{ getTotalPnL() >= 0 ? 'Profit' : 'Loss' }}</div>
              <div 
                class="stat-value"
                [style.color]="getTotalPnL() >= 0 ? '#4caf50' : '#f44336'">
                ‚Çπ{{ formatNumber(Math.abs(getTotalPnL())) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- V2 Dashboard Tab -->
    <div *ngIf="activeTab === 'v2'" class="tab-content">
      <app-dashboard-v2 [contracts]="contracts" (contractsChange)="onContractsChange($event)"></app-dashboard-v2>
    </div>

    <!-- Change Track Tab -->
    <div *ngIf="activeTab === 'change-track'" class="tab-content">
      <app-change-track></app-change-track>
    </div>

    <!-- Stock Radar Tab -->
    <div *ngIf="activeTab === 'stock-radar'" class="tab-content">
      <app-stock-radar></app-stock-radar>
    </div>

    <!-- Help Tab -->
    <div *ngIf="activeTab === 'help'" class="tab-content">
      <app-help></app-help>
    </div>
  </div>
</div>
